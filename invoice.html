<!DOCTYPE html>
<!-- <script>let sqlite3 = require("sqlite3").verbose();</script> -->
<!-- let sqlite3 = require("sqlite3").verbose(); -->
<head>
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="description" content="Responsive Admin Dashboard Template">
   <meta name="keywords" content="admin,dashboard">
   <meta name="author" content="stacks">
   <!-- The above 6 meta tags *must* come first in the head; any other head content must come *after* these tags -->
   
   <!-- Title -->
   <title>Car Work Shop</title>

   <!-- Styles -->
   <!-- <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap" rel="stylesheet"> -->
   <link href="assets/css/materialIcon.css" rel="stylesheet">
   <link href="assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
   <link href="assets/plugins/font-awesome/css/all.min.css" rel="stylesheet">
 
   <!-- Theme Styles -->
   <link href="assets/css/lime.min.css" rel="stylesheet">
   <link href="assets/css/custom.css" rel="stylesheet">
      <!-- <script> var baseUrl="https://mainterior.pk/erpapi/old"; </script> -->
   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
   <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
   <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->
</head>   
<span id="to_hide">
   <body>
<div class="lime-container">
 
           <div class="lime-body">
               <div class="container" style="margin-top: 40px;">
                   <div class="row">
                       <div class="col-md-12">
                           <div class="page-title">
                               <nav aria-label="breadcrumb">
                               
                               </nav>
                               <a><i class="fa fa-arrow-left" id="back" style="font-size: larger; cursor: pointer; display: inline; font-weight: 400px; margin-top: 10px;  margin-left: 20px; "></i></a>

                               <h3 style="display: inline;">Invoice</h3>
                           </div>
                       </div>
                   </div>
            <div class="lime-body">
               <div class="container" style="margin-top: 20px;">
                   <div class="row">
                   <div class="col-xl">
                           <div class="card"  style="background-color:#dfe7f5;">
                               <div class="card-body">
                                   
                       <div class="col-md-12">
                           <div class="page-title">
                                   <form id='comp_reg' class='comp_reg' >
                                  
                                       <input type="hidden" name='_token' value='{{csrf_token()}}'>
                                       <div class="form-row">
                                           <div class="form-group col-md-6">
                                               <label for="name">Date</label>
                                               <input type="date"  id="inputdate" name="sdate" class="form-control"  placeholder="" require>
                                           </div>
                                           <div class="form-group col-md-6">
                                               <label for="name">Name</label>
                                               <input type="text"  id="companyName"  name="cName" class="form-control"  placeholder="" require>
                                           </div>
                                       </div>
                                      
                                      <div class="form-row" id="1" >
                                       <table class="table" id="products_table">
                                           <thead>
                                               <tr>
                                                   <th>Description</th>
                                                   <th>Quantity</th>
                                                   <th>Unit Price</th>
                                                   <th>Sub Total</th>
                                               </tr>
                                           </thead>
                                           <tbody>
                                               <tr id="product0">
                                                   <!-- <td> -->
                                                      
                                                          
                                                           <input type="hidden"  id="inputS.no" name="sno" class="form-control"  placeholder="" require disabled value=1>
                                                       
                                                   
                                                   <td>
                                                      
                                                          
                                                           <textarea class="form-control" id="qtDescription" name="des"  style="height:43px;" ></textarea>
                                                        
                                                       
                                                   </td>
                                                   <td>
                                                       
                                                           <input type="number" id="inputquantity"name="qty" class="form-control" placeholder="" require>
                                                       
                                                   </td>
                                                   <td>
                                                     
                                                         
                                                           <input type="number" id="uprice" name="unit" class="form-control unit"  placeholder="" require>
                                                     
                                                   </td>
                                                   <td>

                                                           <input type="number" name="amount" id="tprice" class="form-control "  placeholder="" require>
                                                   </td>
                                               </tr>
                                               <tr id="product1"></tr>
                                           </tbody>
                                       </table>
                           
                                       <div class="row">
                                           <div class="col-md-12">
                                               <button id="add_row" class="btn btn-info pull-left">+ Add Row</button>
                                               <button id='delete_row' class="pull-right btn btn-danger">- Delete Row</button>
                                           </div>
                                       </div>     
                                   
                              
                           <div class="container">
                            <div class="row">
                             <div class="col-sm-8 m-t-xxl">
                                 <div class="invoice-info">
                                     <span class="bold m-b-md d-block">Info:</span>
                                     <p>Computer Generated Bill</p>
                                 </div>
                             </div>
                             <div class="col-sm-4 m-t-xxl">
                                <table>
                                    <tr>
                                        <td>Sub-Total:</td>
                                        <td><span id="sub_total">0</span></td>
                                        
                                    </tr>  
                                    <tr>
                                        <td>Tax:</td>
                                        <td><input type="number" name="txa" id="tax"class="form-control col-md-5"  placeholder="" style="height: 5%; display: inline;">
                                         <select class="form-control col-md-5" style="display: inline;" id="select_tax">
                                            <option value="flat">Flat</option>
                                            <option value="percentage" selected>%</option>
                                         </select></td>
                                        
                                    </tr>  
                                    <tr>
                                     <td>Discount:</td>
                                     <td><input type="number" name="dis" id="discount" class="form-control col-md-5 "  placeholder="" style="height: 5%; display: inline;">
                                         <select class="form-control col-md-5" id="select_discount"style="display: inline;">
                                             <option value="flat">Flat</option>
                                             <option value="percentage" selected>%</option>
                                         </select>
                                     </td>
                                     
                                     <tr>
                                         <td>
                                             Total:
                                         </td>
                                         <td><span id="total_db">0</span></td>
                                     </tr>
                                 </tr>  
                                  </table>
                             </div>
                         </div>                                     
                        </div>
                    </form>
                </div>
            </div>
                           <div class="row">
                               <button type="button" id="submit" class="btn btn-primary btn-block">Submit</button>
                               <!-- <button type="button" id="back" class="btn btn-primary btn-block">Back</button> -->
                           </div>
                       </div>
                   </div>
</div>
</div>
</div>
</div>  
</div>
</span>
<script>window.$ = window.jQuery = require('./assets/plugins/jquery/jquery-3.1.0.min.js');</script>
<script>window.richText=window.rich=require("./assets/plugins/jquery/jquery.richtext.js")</script>
                   <!-- <script src="./assets/plugins/jquery/jquery-3.1.0.min.js"> </script> -->
                   <!-- <script src="./assets/plugins/jquery/jquery.richtext.js"></script> -->
                   <!-- <script src="./assets/plugins/jquery/jquery.richtext.min.js"></script>                 
                   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
                   <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
                   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script> -->

<!-- <script>
var is_login_page=false;
var element = document.getElementById("quot");
 element.classList.add("active");
< /script> -->
<script>
$(document).ready(function(){
// console.log($("#total_db").text())
// var s=0;
    
//     $('table').keyup(function(e) {
//         var q=0;
//         var u=0;
//      q=$(e.target).closest("tr").find("#inputquantity").val();
//      u=$(e.target).closest("tr").find("#uprice").val();
//      s=q*u;

//      $(e.target).closest("tr").find("#tprice").val(s)
     
//   });
    var tax_final=0
    var discount_final=0;
    var final=0;
        var s=0;
        var sub_tt=0;
        $('#products_table').keyup(function(e) {
            var q=0;
            var u=0;
        q=$(e.target).closest("tr").find("#inputquantity").val();
        u=$(e.target).closest("tr").find("#uprice").val();
        s=q*u;
        //  sub_tt+=s
        //   sub_tt=s;  
        $(e.target).closest("tr").find("#tprice").val(s)
        //  $("#sub_total").text(0)
        sub_tt=0;
        for (var i=0;i<row_number;i++){
            var t=$("#product"+i).find("#tprice").val()
            t=parseInt(t);
            sub_tt+=t;
        }

        //  console.log($('tabel').find('#tprice').val())

        $("#sub_total").text(sub_tt)
        final=sub_tt;
        let d=$('#discount').val()
        let temp_tax=$('#tax').val()
        d=parseInt(d)
        temp_tax=parseInt(temp_tax)
        if(d && temp_tax){
            sub_tt-=d;
            sub_tt+=temp_tax
            $('#total_db').text(sub_tt)
        }
        else if(d && !temp_tax){
            sub_tt-=d;
            //  sub_tt+=t
            $('#total_db').text(sub_tt)
        }
        else if(!d && temp_tax){
            // sub_tt-=d;
            sub_tt+=temp_tax
            $('#total_db').text(sub_tt)
        }
        else{
            $('#total_db').text(sub_tt)
        }
        

        
    });
    $("#discount").keyup(function(){
        // let temp2=0
        discount_final=0;
        var temp=$("#sub_total").text()
        let temp2=$(this).val()
        temp2=parseInt(temp2)
        // console.log("---",final)
        var discount_type=$('#select_discount').val();
        console.log(discount_type)
        if(discount_type=="percentage"){
            temp2=(temp/100)*temp2
            discount_final=temp2
            if(!temp2){
                discount_final=0
                $('#total_db').text(sub_tt+tax_final)
            }
            else{
                $('#total_db').text(tax_final+sub_tt-discount_final)
        }
    }
        else{
            discount_final=temp2
            if(!temp2){
                discount_final=0
                $('#total_db').text(sub_tt+tax_final)
            }
            else{
                $('#total_db').text(tax_final+sub_tt-discount_final)
        }
        }
    })

    $("#tax").keyup(function(){
        tax_final=0;
        var temp2=0
        var temp=$("#sub_total").text()
        temp=parseInt(temp)
        temp2=$(this).val()
        temp2=parseInt(temp2)
        var tax_type=$("#select_tax").val()
        //   console.log(tax_type)
        if(tax_type=="percentage"){
            temp2=(temp/100)*temp2
            //   temp2+=temp;
            tax_final=temp2;
            //   console.log("my new value is ",temp2)
            final=temp2
            if(!temp2){
        //     final=sub_tt;
        tax_final=0
            $('#total_db').text(sub_tt-discount_final)        
        }
        else{
            $('#total_db').text(tax_final+sub_tt-discount_final)

        }   
        }
        else{
            // temp2+=temp;
            console.log("-----",temp2)
            tax_final=temp2
            if(!temp2){
        //     final=sub_tt;
        tax_final=0;
            $('#total_db').text(sub_tt-discount_final)        
        }
        else{
            $('#total_db').text(tax_final+sub_tt-discount_final)

        } 
        
        }
        
    })
    $('#select_discount').change(function(){
        //   alert("hello")
        var type=$(this).val()
        var temp=$("#sub_total").text()
        var discount=$('#discount').val()
        temp=parseInt(temp)
        discount=parseInt(discount)

        
        if(discount_final!=0){
            if(type==="percentage"){
                // alert(discount_final)
                discount_final=(temp/100)*discount
                $('#total_db').text(tax_final+temp-discount_final)
            }
            if(type==="flat"){
                discount_final=discount
                $('#total_db').text(tax_final+temp-discount_final)
            }
            
        }
    })
    $('#select_tax').change(function(){
        //   alert("hello")
        var type=$(this).val()
        var tax=$('#tax').val()
        var temp=$("#sub_total").text()
        temp=parseInt(temp)
        tax=parseInt(tax)

        var discount=$('#discount').val()
        if(tax_final!=0){
            if(type==="percentage"){
                // alert(discount_final)
                tax_final=(temp/100)*tax
                $('#total_db').text(tax_final+temp-discount_final)
            }
            if(type==="flat"){
                tax_final=tax
                $('#total_db').text(tax_final+temp-discount_final)
            }
            
        }
    })
    
   var row_number = 1;
   $("#add_row").click(function(e){
     e.preventDefault();
     let new_row_number = row_number - 1;
     $('#product' + row_number).html($('#product' + new_row_number).html()).find('td:first-child');
     $('#products_table').append('<tr id="product' + (row_number + 1) + '"></tr>');
     row_number++;
   });

   $("#delete_row").click(function(e){
     e.preventDefault();
     if(row_number > 1){
       $("#product" + (row_number - 1)).html('');
       row_number--;
     }
   });
//    HTMLInputElementObject.addEventListener('input', function (evt) {
//     something(this.value);
//     console.log("hi")
// });
                       $('#back').on('click',function(){
                         location.replace('dashboard.html');
                       })
 });
//   $("#inputS.no").mask('0000');
//   $("#inputquantity").mask('0000');
//   $("#uprice").mask('0000');
//   $("#tprice").mask('0000000');
 


var invoiceProducts ={};

function getinvoiceProducts(serNo,descr,quan,un,sutotal){
    
invoiceProducts.sno=serNo;
invoiceProducts.desc=descr;
invoiceProducts.qty=quan;
invoiceProducts.unitPrice=un;
invoiceProducts.SubTotal=sutotal;
console.log(invoiceProducts)
}


// copy array elements to th object


$('#submit').on('click',function(){

        var formData = $("form").serializeArray()
        var date;
        var Name;
        //    var EDatee;
        var descr=[];
        var quan=[];
        var un=[];
        var sutotal=[];
        var tx;
        var dis;
        console.log(formData);

  for(var k = 0; k < formData.length;k++){
      
       if(formData[k].name=='cName'){
          Name=formData[k].value;
          console.log(Name);
      }
      else if(formData[k].name=='sno'){
          serNo.push(formData[k].value)
          console.log(serNo);
      }
      else if(formData[k].name=='des'){
          descr.push(formData[k].value)
          console.log(descr);
      }
      else if(formData[k].name=='qty'){
          quan.push(formData[k].value);
          console.log(quan);
      }
      else if(formData[k].name=='unit'){
          un.push(formData[k].value);
          console.log(un);
      }
      else if(formData[k].name=='amount'){
          sutotal.push(formData[k].value)
          console.log(sutotal);
      }
      else if(formData[k].name=='dis'){
          dis=formData[k].value;
          console.log(dis);
      }
      else if(formData[k].name=='txa'){
          tx=formData[k].value;
          console.log(tx);
      }
      else if((k+1) == formData.length){
         
         console.log((k+1) == formData.length)
         getinvoiceProducts(serNo,descr,quan,un,sutotal);
       }

  }

let db = require("better-sqlite3")("./carWorkshop.db")

    db.prepare(`CREATE TABLE IF NOT EXISTS invoice (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,name TEXT NOT NULL,Date TEXT NOT NULL,sub_total INTEGER NOT NULL,total INTEGER NOT NULL,tax DOUBLE NOT NULL,tax_type TEXT NOT NULL,discount DOUBLE NOT NULL,discount_type TEXT NOT NULL)`).run();
        const sql=`INSERT INTO invoice (name,Date,sub_total,total,tax,tax_type,discount,discount_type)
                VALUES(?,?,?,?,?,?,?,?)`;
    db.prepare(sql).run([$('#companyName').val(),$('#inputdate').val(),$('#sub_total').text(),$("#total_db").text(),$('#tax').val(),$('#select_tax').val(),$('#discount').val(),$('#select_discount').val()])
        // console.log("done")
        db.prepare(`CREATE TABLE IF NOT EXISTS invoice_details (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,invoice_id INTEGER NOT NULL,description TEXT NOT NULL,qty INTEGER NOT NULL,unit_price DOUBLE NOT NULL,sub_total DOUBLE NOT NULL,FOREIGN KEY (invoice_id) REFERENCES invoice (id))`).run()
                const res=db.prepare(`SELECT id from invoice ORDER BY id desc LIMIT 1`).run()

            for (var i=0; i<descr.length;i++){
                // yaha say colunms dekhlay
            const sql=`INSERT INTO invoice_details (invoice_id,description,qty,unit_price,sub_total)
                VALUES(?,?,?,?,?)`;
                // yaha per values dalengi
                // console.log(res.lastInsertRowid)
                db.prepare(sql).run([res.lastInsertRowid,descr[i],quan[i],un[i],sutotal[i]])
                    // if(err) console.log(err)
        }
        localStorage.setItem("is_duplicate","false");

                    localStorage.setItem("invoice_id",res.lastInsertRowid);
                    db.close();

                    const Swal = require('sweetalert2')
                    Swal.fire({
                            title: 'Your Bill is Saved',
                            text: "Saved",
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'ok',
                            confirmButtonColor: "blue",
                        }).then((result)=>{
                            if (result.isConfirmed) {
                                location.href="./printslip.html"

                            }
                        })
})
 
</script>
 </body>
 </html>                  
 
 
